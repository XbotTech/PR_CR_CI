name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          set -e

          echo "üöÄ Start PR notify"

          # ===============================
          # GitHub Áî®Êà∑ -> È£û‰π¶ user_id Êò†Â∞Ñ
          # ===============================
          declare -A USER_MAP
          USER_MAP["x-jipeng"]="ou_1b27da09b4e12ca7c31891a66160c902"
          USER_MAP["HKFoundation"]="ou_3939a6eb92f5819b2c7ca938dfdf53ab"
          USER_MAP["zhangXuXbotgo"]="ou_ffdd59a56be567c7551ee786b2d091ec"

          get_user_id() {
            echo "${USER_MAP[$1]}"
          }

          # ===============================
          # ÊûÑÂª∫È£û‰π¶Ê∂àÊÅØÔºàpost Á±ªÂûãÔºâ
          # ===============================
          build_post() {
            local title="$1"
            local at_user="$2"
            local text="$3"

            echo "{
              \"msg_type\": \"post\",
              \"content\": {
                \"post\": {
                  \"zh_cn\": {
                    \"title\": \"$title\",
                    \"content\": [
                      [
                        { \"tag\": \"at\", \"user_id\": \"$at_user\" },
                        { \"tag\": \"text\", \"text\": \" $text\" }
                      ]
                    ]
                  }
                }
              }
            }"
          }

          EVENT="${{ github.event_name }}"
          echo "EVENT=$EVENT"

          # ===============================
          # PR ‰∫ã‰ª∂
          # ===============================
          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"

            AUTHOR_ID=$(get_user_id "$AUTHOR")

            if [[ "$ACTION" == "opened" ]]; then
              BODY=$(build_post "üÜï PR ÂàõÂª∫" "$AUTHOR_ID" "ÂàõÂª∫‰∫Ü PRÔºö$TITLE")

            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              BODY=$(build_post "‚úÖ PR Â∑≤ÂêàÂπ∂" "$AUTHOR_ID" "PR Â∑≤ÂêàÂπ∂Ôºö$TITLE")

            else
              echo "ÂøΩÁï•‰∫ã‰ª∂: $ACTION"
              exit 0
            fi

          # ===============================
          # PR ÂÆ°Ê†∏‰∫ã‰ª∂
          # ===============================
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            TITLE="${{ github.event.pull_request.title }}"

            REVIEWER_ID=$(get_user_id "$REVIEWER")
            AUTHOR_ID=$(get_user_id "$AUTHOR")

            if [[ "$STATE" == "approved" ]]; then
              BODY=$(build_post "üëç PR Â∑≤ÈÄöËøáÂÆ°Ê†∏" "$AUTHOR_ID" "ÂÆ°Ê†∏‰∫∫Ôºö$REVIEWER")

            elif [[ "$STATE" == "changes_requested" ]]; then
              BODY=$(build_post "‚ùå PR Ë¢´Ë¶ÅÊ±Ç‰øÆÊîπ" "$AUTHOR_ID" "ÂÆ°Ê†∏‰∫∫Ôºö$REVIEWER")

            else
              echo "ÂøΩÁï• review Áä∂ÊÄÅ: $STATE"
              exit 0
            fi
          fi

          echo "========== FEISHU PAYLOAD =========="
          echo "$BODY"
          echo "==================================="

          curl -s -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$BODY"

