name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          set -e

          declare -A USER_MAP
          USER_MAP["x-jipeng"]="ou_1b27da09b4e12ca7c31891a66160c902"
          USER_MAP["HKFoundation"]="ou_3939a6eb92f5819b2c7ca938dfdf53ab"
          USER_MAP["zhangXuXbotgo"]="ou_ffdd59a56be567c7551ee786b2d091ec"

          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"

          get_user_id() {
            echo "${USER_MAP[$1]}"
          }

          build_post() {
            local title="$1"
            local at_user="$2"
            local text="$3"

            cat <<EOF
{
  "msg_type": "post",
  "content": {
    "post": {
      "zh_cn": {
        "title": "$title",
        "content": [
          [
            { "tag": "at", "user_id": "$at_user" },
            { "tag": "text", "text": " $text" }
          ]
        ]
      }
    }
  }
}
EOF
          }

          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"

            AUTHOR_ID=$(get_user_id "$AUTHOR")

            if [[ "$ACTION" == "opened" ]]; then
              BODY=$(build_post "ðŸ†• PR åˆ›å»º" "$AUTHOR_ID" "åˆ›å»ºäº† PRï¼š$TITLE")
            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              BODY=$(build_post "âœ… PR å·²åˆå¹¶" "$AUTHOR_ID" "PR å·²åˆå¹¶ï¼š$TITLE")
            else
              exit 0
            fi

          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            TITLE="${{ github.event.pull_request.title }}"

            REVIEWER_ID=$(get_user_id "$REVIEWER")
            AUTHOR_ID=$(get_user_id "$AUTHOR")

            if [[ "$STATE" == "approved" ]]; then
              BODY=$(build_post "ðŸ‘ PR å·²é€šè¿‡å®¡æ ¸" "$AUTHOR_ID" "å®¡æ ¸äººï¼š$REVIEWER")
            elif [[ "$STATE" == "changes_requested" ]]; then
              BODY=$(build_post "âŒ PR è¢«è¦æ±‚ä¿®æ”¹" "$AUTHOR_ID" "å®¡æ ¸äººï¼š$REVIEWER")
            else
              exit 0
            fi
          fi

          echo "$BODY"

          curl -s -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$BODY"

