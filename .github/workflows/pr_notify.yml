name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send message to Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            URL="${{ github.event.pull_request.html_url }}"
            REPO="${{ github.repository }}"

            if [[ "$ACTION" == "opened" ]]; then
              MSG="ğŸ†• PR å·²åˆ›å»º"
            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              MSG="âœ… PR å·²åˆå¹¶"
            elif [[ "$ACTION" == "closed" ]]; then
              MSG="âŒ PR å·²å…³é—­"
            else
              MSG="â„¹ï¸ PR æ›´æ–°"
            fi

            OPERATOR="$AUTHOR"

          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            REPO="${{ github.repository }}"

            if [[ "$STATE" == "approved" ]]; then
              MSG="ğŸ‘ PR å·²é€šè¿‡å®¡æ ¸"
            elif [[ "$STATE" == "changes_requested" ]]; then
              MSG="âŒ PR è¢«è¯·æ±‚ä¿®æ”¹"
            else
              MSG="ğŸ’¬ PR æ–°è¯„è®º"
            fi

            OPERATOR="$REVIEWER"
          fi

          curl -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"$MSG\n\nğŸ“¦ ä»“åº“: $REPO\nğŸ‘¤ æ“ä½œäºº: $OPERATOR\nğŸ“„ æ ‡é¢˜: $TITLE\nğŸ”— é“¾æ¥: $URL\"
              }
            }"

