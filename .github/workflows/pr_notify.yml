name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          set -e

          echo "üöÄ PR Notify Start"

          ################################
          # GitHub Áî®Êà∑ -> È£û‰π¶ user_id
          ################################
          declare -A USER_MAP
          USER_MAP["x-jipeng"]="ou_1b27da09b4e12ca7c31891a66160c902"
          USER_MAP["HKFoundation"]="ou_3939a6eb92f5819b2c7ca938dfdf53ab"
          USER_MAP["zhangXuXbotgo"]="ou_ffdd59a56be567c7551ee786b2d091ec"

          ################################
          # Â∑•ÂÖ∑ÂáΩÊï∞
          ################################

          get_user_id() {
            echo "${USER_MAP[$1]}"
          }

          # ÊûÑÂª∫ @ ‰∫∫ËäÇÁÇπÔºàÊîØÊåÅÂ§ö‰∏™Ôºâ
          build_at_nodes() {
            local users=("$@")
            local nodes=""

            for u in "${users[@]}"; do
              uid="${USER_MAP[$u]}"
              if [[ -n "$uid" ]]; then
                nodes="$nodes {\"tag\":\"at\",\"user_id\":\"$uid\"},"
              fi
            done

            echo "${nodes%,}"
          }

          # ÊûÑÂª∫È£û‰π¶Ê∂àÊÅØ
          build_post() {
            local title="$1"
            local repo="$2"
            local actor="$3"
            local pr_title="$4"
            local url="$5"
            shift 5
            local at_users=("$@")

            local at_nodes
            at_nodes=$(build_at_nodes "${at_users[@]}")

            jq -n \
              --arg title "$title" \
              --arg repo "$repo" \
              --arg actor "$actor" \
              --arg pr_title "$pr_title" \
              --arg url "$url" \
              --argjson at_nodes "[$at_nodes]" '
              {
                msg_type: "post",
                content: {
                  post: {
                    zh_cn: {
                      title: $title,
                      content: [
                        [
                          { "tag": "text", "text": "üì¶ ‰ªìÂ∫ì: " },
                          { "tag": "text", "text": $repo }
                        ],
                        [
                          { "tag": "text", "text": "üë§ Êìç‰Ωú‰∫∫: " },
                          { "tag": "text", "text": $actor }
                        ],
                        [
                          { "tag": "text", "text": "üìÑ Ê†áÈ¢ò: " },
                          { "tag": "text", "text": $pr_title }
                        ],
                        [
                          { "tag": "text", "text": "üîó ÈìæÊé•: " },
                          { "tag": "a", "text": $url, "href": $url }
                        ],
                        $at_nodes
                      ]
                    }
                  }
                }
              }
            '
          }

          ################################
          # ÂÖ¨ÂÖ±ÂèòÈáè
          ################################
          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          ################################
          # PR ÂàõÂª∫ / ÂêàÂπ∂
          ################################
          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"

            # ‰Ω†ÂèØ‰ª•Âú®ËøôÈáåÁª¥Êä§ÂÆ°Ê†∏‰∫∫
            REVIEWERS=("x-jipeng" "HKFoundation")

            if [[ "$ACTION" == "opened" ]]; then
              BODY=$(build_post \
                "üÜï PR Â∑≤ÂàõÂª∫" \
                "$REPO" \
                "$AUTHOR" \
                "$TITLE" \
                "$URL" \
                "${REVIEWERS[@]}"
              )

            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              BODY=$(build_post \
                "‚úÖ PR Â∑≤ÂêàÂπ∂" \
                "$REPO" \
                "$AUTHOR" \
                "$TITLE" \
                "$URL" \
                "${REVIEWERS[@]}" "$AUTHOR"
              )
            else
              exit 0
            fi

          ################################
          # PR ÂÆ°Ê†∏
          ################################
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"

            if [[ "$STATE" == "approved" ]]; then
              BODY=$(build_post \
                "üëç PR Â∑≤ÈÄöËøáÂÆ°Ê†∏" \
                "$REPO" \
                "$REVIEWER" \
                "$TITLE" \
                "$URL" \
                "$AUTHOR"
              )

            elif [[ "$STATE" == "changes_requested" ]]; then
              BODY=$(build_post \
                "‚ùå PR Ë¢´Ë¶ÅÊ±Ç‰øÆÊîπ" \
                "$REPO" \
                "$REVIEWER" \
                "$TITLE" \
                "$URL" \
                "$AUTHOR"
              )
            else
              exit 0
            fi
          fi

          echo "========== FEISHU MESSAGE =========="
          echo "$BODY"
          echo "==================================="

          curl -s -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$BODY"

