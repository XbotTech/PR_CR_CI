name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          # -------------------------
          # ç”¨æˆ·æ˜ å°„ï¼ˆGitHub -> é£ä¹¦ï¼‰
          # -------------------------
          declare -A USER_MAP
          USER_MAP["x-jipeng"]="ou_1b27da09b4e12ca7c31891a66160c902"
          USER_MAP["HKFoundation"]="ou_3939a6eb92f5819b2c7ca938dfdf53ab"
          USER_MAP["zhangXuXbotgo"]="ou_ffdd59a56be567c7551ee786b2d091ec"

          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"

          get_user_tag() {
            local user=$1
            local uid=${USER_MAP[$user]}
            if [[ -n "$uid" ]]; then
              echo "<at user_id=\"$uid\"></at>"
            else
              echo "@$user"
            fi
          }

          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            URL="${{ github.event.pull_request.html_url }}"

            AUTHOR_TAG=$(get_user_tag "$AUTHOR")

            if [[ "$ACTION" == "opened" ]]; then
              MSG="ğŸ†• PR å·²åˆ›å»º\nğŸ‘¤ å‘èµ·äººï¼š$AUTHOR_TAG\nğŸ“„ æ ‡é¢˜ï¼š$TITLE\nğŸ”— $URL"
            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              MSG="âœ… PR å·²åˆå¹¶\nğŸ‘¤ å‘èµ·äººï¼š$AUTHOR_TAG\nğŸ“„ æ ‡é¢˜ï¼š$TITLE\nğŸ”— $URL"
            else
              MSG="âŒ PR å·²å…³é—­\nğŸ‘¤ å‘èµ·äººï¼š$AUTHOR_TAG\nğŸ“„ æ ‡é¢˜ï¼š$TITLE\nğŸ”— $URL"
            fi

          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"

            REVIEWER_TAG=$(get_user_tag "$REVIEWER")
            AUTHOR="${{ github.event.pull_request.user.login }}"
            AUTHOR_TAG=$(get_user_tag "$AUTHOR")

            if [[ "$STATE" == "approved" ]]; then
              MSG="ğŸ‘ PR å·²é€šè¿‡å®¡æ ¸\nğŸ‘¤ å®¡æ ¸äººï¼š$REVIEWER_TAG\nğŸ‘¤ å‘èµ·äººï¼š$AUTHOR_TAG\nğŸ“„ æ ‡é¢˜ï¼š$TITLE\nğŸ”— $URL"
            elif [[ "$STATE" == "changes_requested" ]]; then
              MSG="âŒ PR è¢«è¯·æ±‚ä¿®æ”¹\nğŸ‘¤ å®¡æ ¸äººï¼š$REVIEWER_TAG\nğŸ‘¤ å‘èµ·äººï¼š$AUTHOR_TAG\nğŸ“„ æ ‡é¢˜ï¼š$TITLE\nğŸ”— $URL"
            fi
          fi

          curl -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"$MSG\"
              }
            }"

