name: PR Notify to Feishu

on:
  pull_request:
    types: [opened, closed, reopened]

  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          set -e

          echo "üöÄ PR Notify Start"

          ################################
          # GitHub Áî®Êà∑ ‚Üí È£û‰π¶ user_id + ÈÇÆÁÆ±
          ################################
          declare -A USER_MAP
          declare -A USER_EMAIL

          USER_MAP["x-jipeng"]="ou_1b27da09b4e12ca7c31891a66160c902"
          USER_EMAIL["x-jipeng"]="pengji@xbotgo.com"

          USER_MAP["HKFoundation"]="ou_3939a6eb92f5819b2c7ca938dfdf53ab"
          USER_EMAIL["HKFoundation"]="liusen@xbotgo.com"

          USER_MAP["zhangXuXbotgo"]="ou_ffdd59a56be567c7551ee786b2d091ec"
          USER_EMAIL["zhangXuXbotgo"]="zhangxu@xbotgo.com"

          USER_MAP["lihuize-xbotgo"]="ou_99b2693a8be2da8947303bfd741ebcb2"
          USER_EMAIL["lihuize-xbotgo"]="lihuize@xbotgo.com"

          USER_MAP["niuzhonglei"]="ou_1cded209788734c9c3e1edd3ad9be2d4"
          USER_EMAIL["niuzhonglei"]="niuzhonglei@xbotgo.com"

          USER_MAP["van6855"]="ou_9b8be51926380279b2d9c2fe0b4d11d3"
          USER_EMAIL["van6855"]="wangfan@xbotgo.com"

          USER_MAP["xbotgo-gaoyunfeng"]="ou_ec58147bda11d60846e8c601e18c6913"
          USER_EMAIL["xbotgo-gaoyunfeng"]="gaoyunfeng@xbotgo.com"

          USER_MAP["zhoulong-xbotgo"]="ou_8b4e30691faa20dbfb428aa0bc726126"
          USER_EMAIL["zhoulong-xbotgo"]="zhoulong@xbotgo.com"

          USER_MAP["haoareuuuu"]="ou_59b7d4c075f125d50df8a93afa9fb296"
          USER_EMAIL["haoareuuuu"]="hanshenglong@xbotgo.com"

          USER_MAP["Long-Xbot"]="ou_c4f6cc32408ce08e7c914329c02732fc"
          USER_EMAIL["Long-Xbot"]="jinghuilong@xbotgo.com"

          ################################
          # Â∑•ÂÖ∑ÂáΩÊï∞
          ################################
          get_email() {
            echo "${USER_EMAIL[$1]}"
          }

          build_at_nodes() {
            local users=("$@")
            local nodes=""

            for u in "${users[@]}"; do
              uid="${USER_MAP[$u]}"
              [[ -n "$uid" ]] && nodes="$nodes {\"tag\":\"at\",\"user_id\":\"$uid\"},"
            done

            echo "${nodes%,}"
          }

          build_post() {
            local title="$1"
            local repo="$2"
            local operator="$3"
            local pr_title="$4"
            local url="$5"
            shift 5
            local at_users=("$@")

            local at_nodes
            at_nodes=$(build_at_nodes "${at_users[@]}")

            jq -n \
              --arg title "$title" \
              --arg repo "$repo" \
              --arg operator "$operator" \
              --arg pr_title "$pr_title" \
              --arg url "$url" \
              --argjson at_nodes "[$at_nodes]" '
              {
                msg_type: "post",
                content: {
                  post: {
                    zh_cn: {
                      title: $title,
                      content: [
                        [
                          { "tag": "text", "text": "üì¶ ‰ªìÂ∫ì: " },
                          { "tag": "text", "text": $repo }
                        ],
                        [
                          { "tag": "text", "text": "üë§ Êìç‰Ωú‰∫∫: " },
                          { "tag": "text", "text": $operator }
                        ],
                        [
                          { "tag": "text", "text": "üìÑ Ê†áÈ¢ò: " },
                          { "tag": "text", "text": $pr_title }
                        ],
                        [
                          { "tag": "text", "text": "üîó ÈìæÊé•: " },
                          { "tag": "a", "text": $url, "href": $url }
                        ],
                        $at_nodes
                      ]
                    }
                  }
                }
              }
            '
          }

          ################################
          # ÂÖ¨ÂÖ±ÂèòÈáè
          ################################
          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          AUTHOR_EMAIL=$(get_email "$AUTHOR")

          ################################
          # PR ‰∫ã‰ª∂
          ################################
          if [[ "$EVENT" == "pull_request" ]]; then
            ACTION="${{ github.event.action }}"

            # ËøôÈáåÂÆö‰πâÈªòËÆ§ÂÆ°Ê†∏‰∫∫
            REVIEWERS=("x-jipeng")

            if [[ "$ACTION" == "opened" ]]; then
              BODY=$(build_post \
                "üÜï PR Â∑≤ÂàõÂª∫" \
                "$REPO" \
                "$AUTHOR_EMAIL" \
                "$TITLE" \
                "$URL" \
                "${REVIEWERS[@]}"
              )

            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              BODY=$(build_post \
                "‚úÖ PR Â∑≤ÂêàÂπ∂" \
                "$REPO" \
                "$AUTHOR_EMAIL" \
                "$TITLE" \
                "$URL" \
                "${REVIEWERS[@]}" "$AUTHOR"
              )
            else
              exit 0
            fi

          ################################
          # ÂÆ°Ê†∏‰∫ã‰ª∂
          ################################
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            STATE="${{ github.event.review.state }}"
            REVIEWER="${{ github.event.review.user.login }}"
            REVIEWER_EMAIL=$(get_email "$REVIEWER")

            if [[ "$STATE" == "approved" ]]; then
              BODY=$(build_post \
                "üëç PR Â∑≤ÈÄöËøáÂÆ°Ê†∏" \
                "$REPO" \
                "$REVIEWER_EMAIL" \
                "$TITLE" \
                "$URL" \
                "$AUTHOR"
              )

            elif [[ "$STATE" == "changes_requested" ]]; then
              BODY=$(build_post \
                "‚ùå PR Ë¢´Ë¶ÅÊ±Ç‰øÆÊîπ" \
                "$REPO" \
                "$REVIEWER_EMAIL" \
                "$TITLE" \
                "$URL" \
                "$AUTHOR"
              )
            else
              exit 0
            fi
          fi

          echo "========== FEISHU MESSAGE =========="
          echo "$BODY"
          echo "==================================="

          curl -s -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$BODY"

